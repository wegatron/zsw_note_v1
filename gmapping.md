---
tag: paper_note
---
## Gmapping
### ç®—æ³•åŸç†
RBPFæ¦‚è¿°: ä¸€ç§SLAMæ–¹æ³•, å°†å®šä½å’Œå»ºå›¾åˆ†ç¦», é€šè¿‡å¸¦æœ‰æƒé‡ã€è½¨è¿¹ã€åœ°å›¾çš„æ•£å¸ƒçš„ç²’å­æ¥è¡¨ç¤ºåœ°å›¾å’Œå®šä½çš„åéªŒæ¦‚ç‡åˆ†å¸ƒ. (*ç±»ä¼¼é‡‡æ ·æšä¸¾æ³•, åªé‡‡æ ·æšä¸¾å¯èƒ½æ€§é«˜çš„ç‚¹*)
Gmappingæ¦‚è¿°: åŸºäºRBPF, é€šè¿‡åŠ å…¥è§‚æµ‹ä¼˜åŒ–äº†æè®®åˆ†å¸ƒ, é€šè¿‡é€‰æ‹©æ€§é‡é‡‡æ ·, é™ä½äº†é‡‡æ ·é¢‘ç‡.

å…³é”®è¯: ç›®æ ‡åˆ†å¸ƒã€æè®®åˆ†å¸ƒã€é€‰æ‹©æ€§é‡é‡‡æ ·ã€ç²’å­é€€åŒ–.

#### è¯¦è§£
##### è´å¶æ–¯æ»¤æ³¢
åŸºæœ¬è´å¶æ–¯ä¼°è®¡çŸ¥è¯†:
![basic_bayes](rc/basic_bayes.png)

è´å¶æ–¯æ»¤æ³¢: å·²çŸ¥çŠ¶æ€é‡$t-1$æ—¶åˆ»çš„æ¦‚ç‡åˆ†å¸ƒ, åœ¨ç»™å®šğ‘¡æ—¶åˆ»çš„è§‚æµ‹æ•°æ®$z_t, u_t$çš„æƒ…å†µä¸‹, ä¼°è®¡å‡ºçŠ¶æ€é‡åœ¨$t$æ—¶åˆ»çš„æ¦‚ç‡åˆ†å¸ƒ.

$$
bel(x_t) = p(x_t|z_{1:t}, u_{1:t}) = \eta p ( z _ { t } | x _ { t } ) \overline { b e l } ( x _ { t } ) = \eta p ( z _ { t } | x _ { t } ) \int p ( x _ { t } | x _ { t - 1 } , u _ { t } ) p ( x _ { t - 1 } | z _ { 1 : t - 1 } , u _ { 1 : t - 1 } ) d x _ { t - 1 }
$$

##### Rao-Blackwellized Particle Filters
å®šä½å’Œå»ºå›¾åˆ†ç¦»:

$$
p(x_{1:t}, m | z_{1:t}, u_{1:t-1}) = p(m|x_{1:t}, z_{1:t}) \cdot p(x_{1:t}|z_{1:t}, u_{1:t-1})
$$

åœ¨ç²’å­æ»¤æ³¢å™¨ä¸­, åéªŒæ¦‚ç‡åˆ†å¸ƒçš„æ ·æœ¬ç§°ä¸ºç²’å­particles

$$
\mathcal{X}_t := x_t^{[1]}, x_t^{[2]}, \cdots, x_t^{[M]}
$$

å…¶ä¸­$\mathcal{X}_t$ä¸ºç²’å­é›†åˆ, æ¯ä¸€ä¸ªç²’å­$x_t^{[m]}, 1 â‰¤ m â‰¤ M$, éƒ½æ˜¯çŠ¶æ€åœ¨tæ—¶åˆ»çš„ä¸€ä¸ªå…·ä½“å®ä¾‹, ä¹Ÿå°±æ˜¯åœ¨tæ—¶åˆ»çœŸå®ä¸–ç•Œå¯èƒ½çŠ¶æ€çš„ä¸€ä¸ªå‡è®¾.

ç²’å­æ»¤æ³¢å™¨èƒŒåçš„æ€æƒ³æ˜¯ç”¨é›†åˆ$\mathcal{X}_t$æ¥è¿‘ä¼¼ç½®ä¿¡åº¦$bel(x_t)$, ç†æƒ³æƒ…å†µä¸‹ç²’å­é›†åˆ$\mathcal{X}_t$ä¸­å«æœ‰çŠ¶æ€å‡è®¾$x_t$çš„ä¼¼ç„¶æ¦‚ç‡åº”å½“ä¸è´å¶æ–¯æ»¤æ³¢å™¨çš„åéªŒæ¦‚ç‡$bel(x_t)$æˆæ­£æ¯”å…³ç³»:

$$
x_t^{[m]} \sim p(x_t | z_{1:t}, u_{1:t})
$$


ç®—æ³•ä¼ªä»£ç :
![rbpf](rc/rbpf_algorithm.png)

RBPFå­˜åœ¨ä¸¤å¤§é—®é¢˜: ç²’å­æ•°å¤š(é€ æˆè®¡ç®—é‡å’Œå†…å­˜æ¶ˆè€—å˜å¤§)ã€é¢‘ç¹é‡é‡‡æ ·(åŠ å‰§äº†ç²’å­é€€åŒ–).
ç²’å­é€€åŒ–: ä¸»è¦æŒ‡æ­£ç¡®çš„ç²’å­è¢«ä¸¢å¼ƒå’Œç²’å­å¤šæ ·æ€§å‡å°, è€Œé¢‘ç¹é‡é‡‡æ ·åˆ™åŠ å‰§äº†æ­£ç¡®çš„ç²’å­è¢«ä¸¢å¼ƒçš„å¯èƒ½æ€§å’Œç²’å­å¤šæ ·æ€§å‡å°é€Ÿç‡.
ç²’å­æƒé‡çš„è®¡ç®—:

$$
\begin{aligned}
w _ { t } ^ { ( i ) } &= \frac { p ( x _ { 1 : t } ^ { ( i ) } | z _ { 1 : t } , u _ { 1 : t - 1 } ) } { \pi ( x _ { 1 : t } ^ { ( i ) } | z _ { 1 : t } , u _ { 1 : t - 1 } ) } \\
 &= \frac { \eta p ( z _ { t } | x _ { 1 : t } ^ { ( i ) } , z _ { 1 : t - 1 } ) p ( x _ { t } ^ { ( i ) } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { \pi ( x _ { t } ^ { ( i ) } | x _ { 1 : t - 1 } ^ { ( i ) } , z _ { 1 : t } , u _ { 1 : t - 1 } ) } \cdot \underbrace { \frac { p ( x _ { 1 : t - 1 } ^ { ( i ) } | z _ { 1 : t - 1 } , u _ { 1 : t - 2 } ) } { \pi ( x _ { 1 : t - 1 } ^ { ( i ) } | z _ { 1 : t - 1 } , u _ { 1 : t - 2 } ) } }_{ w _ { t - 1 } ^ { ( i ) } }\\
 &\propto \frac { p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ^ { ( i ) } ) p ( x _ { t } ^ { ( i ) } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { \pi ( x _ { t } | x _ { 1 : t - 1 } ^ { ( i ) } , z _ { 1 : t } , u _ { 1 : t - 1 } ) } \cdot w _ { t - 1 } ^ { ( i ) }
\end{aligned}
$$

$\eta = 1/p(z_t | z_{1:t-1}, u_{1:t-1})$ æ˜¯ä¸€ä¸ªå½’ä¸€åŒ–å‚æ•°, æ¯ä¸ªç²’å­éƒ½ä¸€æ ·.
$p$æ˜¯ç›®æ ‡åˆ†å¸ƒ: æ ¹æ®æœºå™¨äººæºå¸¦çš„æ‰€æœ‰ä¼ æ„Ÿå™¨çš„æ•°æ®èƒ½ç¡®å®šæœºå™¨äººçŠ¶æ€ç½®ä¿¡åº¦çš„æœ€å¤§æé™.
$\pi$æ˜¯æè®®åˆ†å¸ƒ: ç”±äºæ— æ³•ç›´æ¥å¯¹ç›®æ ‡åˆ†å¸ƒå»ºæ¨¡è¿›è¡Œé‡‡æ ·, æ¯”å¦‚å¯¹äºæ¿€å…‰ä¼ æ„Ÿå™¨, æ— æ³•è¿›è¡Œé«˜æ–¯å»ºæ¨¡. ä½†é—®é¢˜æ˜¯æˆ‘ä»¬å¸Œæœ›ä»ä¸€ä¸ªåˆ†å¸ƒä¸­è¿›è¡Œé‡‡æ ·æ¥è·å–å¯¹ä¸‹ä¸€æ—¶åˆ»æœºå™¨äººä½å§¿çš„ä¼°è®¡, è€Œåœ¨è®¡ç®—æœºä¸­èƒ½æ¨¡æ‹Ÿå‡ºçš„åˆ†å¸ƒä¹Ÿå°±æ˜¯é«˜æ–¯åˆ†å¸ƒã€ä¸‰è§’åˆ†å¸ƒç­‰æœ‰é™çš„åˆ†å¸ƒ, å› æ­¤æè®®åˆ†å¸ƒè¢«æå‡ºæ¥ä»£æ›¿ç›®æ ‡åˆ†å¸ƒæ¥æå–ä¸‹ä¸€æ—¶åˆ»æœºå™¨äººä½å§¿ä¿¡æ¯. è€Œæè®®åˆ†å¸ƒæ¯•ç«Ÿä¸æ˜¯ç›®æ ‡åˆ†å¸ƒå› æ­¤ä½¿ç”¨ç²’å­æƒé‡æ¥è¡¨å¾æè®®åˆ†å¸ƒå’Œç›®æ ‡åˆ†å¸ƒçš„ä¸ä¸€è‡´æ€§. [refer to GMappingåŸç†åˆ†æ]


##### Gmapping
Fast Slamä»¥motion modelä½œä¸ºæè®®åˆ†å¸ƒ:
$$
\begin{aligned}
 w _ { t } ^ { ( i ) } &= w _ { t - 1 } ^ { ( i ) } \frac { \eta p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ^ { ( i ) } ) p ( x _ { t } ^ { ( i ) } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { p ( x _ { t } ^ { ( i ) } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) }\\
&\propto w _ { t - 1 } ^ { ( i ) } \cdot p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ^ { ( i ) } )
\end{aligned}
$$

æ”¹è¿›, ä»¥æ¿€å…‰scanmatchä½œä¸ºæè®®åˆ†å¸ƒ:

$$
p ( x _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t - 1 } ^ { ( i ) } , z _ { t } , u _ { t - 1 } ) =  \frac { p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ) p ( x _ { t } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) }
$$

*æ³¨: ä¸ºä»€ä¹ˆè¦é™¤è¿™ä¸€é¡¹? æˆ‘ä»¬è¦çš„æ˜¯$x_t$çš„åˆ†å¸ƒ, è€Œåˆ†å­ä¸Šæ˜¯$z_t x_t$çš„åˆ†å¸ƒ.*
ä»è€Œæœ‰:

$$
\begin{aligned}
w_t^{(i)} &= w _ { t - 1 } ^ { ( i ) } \frac { \eta p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ^ { ( i ) } ) p ( x _ { t } ^ { ( i ) } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { p ( x _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t - 1 } ^ { ( i ) } , z _ { t } , u _ { t - 1 } ) }\\
&\propto \quad w _ { t - 1 } ^ { ( i ) } \frac { p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ^ { ( i ) } ) p ( x _ { t } ^ { ( i ) } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { \frac { p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t } ) p ( x _ { t } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } { p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) } }\\
&= w _ { t - 1 } ^ { ( i ) } \cdot p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } )\\
&= w _ { t - 1 } ^ { ( i ) } \cdot \int p ( z _ { t } | x ^ { \prime } ) p ( x ^ { \prime } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) d x ^ { \prime }\\
&\simeq w _ { t - 1 } ^ { ( i ) } \cdot \sum _ { j = 1 } ^ { K } p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { j } ) \cdot p ( x _ { j } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } )
\end{aligned}
$$

åœ¨scanmatchçš„æœ‰æ•ˆåŒºåŸŸé‡‡æ ·Kä¸ªç‚¹, è®¡ç®—$\mu$å’Œ$\Sigma$, å¾—åˆ°æè®®é«˜æ–¯åˆ†å¸ƒ:

$$
\begin{aligned}
\mu_t^{(i)} = \frac { 1 } { \eta ^ { ( i ) } } \cdot \sum _ { j = 1 } ^ { K } x_{ j } \cdot p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { j } ) \cdot p ( x _ { j } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } )\\
\Sigma_t^{(i)} = \frac { 1 } { \eta ^ { ( i ) } } \cdot \sum _ { j = 1 } ^ { K } p ( z _ { t } | m _ { t - 1 } ^ { ( i ) } , x _ { j } ) \cdot p ( x _ { j } | x _ { t - 1 } ^ { ( i ) } , u _ { t - 1 } ) ( x _ { j } - \mu _ { t } ^ { ( i ) } ) ( x _ { j } - \mu _ { t } ^ { ( i ) } ) ^ { T }
\end{aligned}
$$

è‹¥åä¸€åˆ»çš„è§‚æµ‹å’Œå‰ä¸€åˆ»çš„ç»“è®ºä¸€è‡´æ€§å¾ˆå¥½, åˆ™ç²’å­æƒé‡å˜åŒ–å¾ˆå°, ä½†è‹¥åä¸€åˆ»çš„è§‚æµ‹å’Œå‰ä¸€åˆ»çš„ç»“è®ºå‡ºç°è¾ƒå¤§åå·®(æ¯”å¦‚é—­ç¯æ—¶å€™), ç²’å­çš„æƒé‡ä¼šå‘ç”Ÿå‰§å˜. ä½“ç°åœ¨(æˆ–è®¸scanmatché…ä¸Šæƒ…å†µæ¯”ä¾‹å‘ç”Ÿå˜åŒ–).

ç®—æ³•ä¼ªä»£ç :
![gmapping1](rc/gmapping_1.png)
![gmapping2](rc/gmapping_2.png)

##### å…³é”®ä»£ç 
å…³é”®ä»£ç ä½äº`openslam_gmapping/gridfastslam/gridslamprocessor.cpp`ä¹‹ä¸­:
```c++
bool GridSlamProcessor::processScan(const RangeReading &reading, int adaptParticles) {
        //write the state of the reading and update all the particles using the motion model
        for (ParticleVector::iterator it = m_particles.begin(); it != m_particles.end(); it++) {
            OrientedPoint &pose(it->pose);
            pose = m_motionModel.drawFromMotion(it->pose, relPose, m_odoPose);
        }

        /*
         * ä¸ºæ¯ä¸ªç²’å­è¿›è¡ŒscanMatchï¼Œè®¡ç®—å‡ºæ¥æ¯ä¸ªç²’å­çš„æœ€ä¼˜ä½å§¿ï¼ŒåŒæ—¶è®¡ç®—æ”¹æœ€ä¼˜ä½å§¿çš„å¾—åˆ†å’Œä¼¼ç„¶
         * å¯¹åº”äºgmappingè®ºæ–‡ä¸­çš„ç”¨æœ€è¿‘çš„ä¸€æ¬¡æµ‹é‡è®¡ç®—proposalçš„ç®—æ³•
         * è¿™é‡Œé¢é™¤äº†è¿›è¡ŒscanMatchä¹‹å¤–ï¼Œè¿˜å¯¹ç²’å­è¿›è¡Œäº†æƒé‡çš„è®¡ç®—ï¼Œ
         * å¹¶è®¡ç®—äº†ç²’å­çš„æœ‰æ•ˆåŒºåŸŸ ä½†ä¸è¿›è¡Œå†…å­˜åˆ†é… å†…å­˜åˆ†é…åœ¨resample()å‡½æ•°ä¸­
         * è¿™ä¸ªå‡½æ•°åœ¨gridslamprocessor.hxxé‡Œé¢
         */
        scanMatch(plainReading);

        // ç”±äºscanMatchä¸­å¯¹ç²’å­çš„æƒé‡è¿›è¡Œäº†æ›´æ–°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å„ä¸ªç²’å­çš„è½¨è¿¹ä¸Šçš„ç´¯è®¡æƒé‡éƒ½éœ€è¦é‡æ–°è®¡ç®—
        // è¿™ä¸ªå‡½æ•°å³æ›´æ–°å„ä¸ªç²’å­çš„è½¨è¿¹ä¸Šçš„ç´¯è®¡æƒé‡æ˜¯æ›´æ–°
        updateTreeWeights(false);

        // ç²’å­é‡é‡‡æ ·  æ ¹æ®neffçš„å¤§å°æ¥è¿›è¡Œé‡é‡‡æ ·  ä¸ä½†è¿›è¡Œäº†é‡é‡‡æ ·ï¼Œä¹Ÿå¯¹åœ°å›¾è¿›è¡Œæ›´æ–°
        // GridSlamProcessor::resample å‡½æ•°åœ¨gridslamprocessor.hxxé‡Œé¢å®ç°
        resample(plainReading, adaptParticles, reading_copy);
}
```

### æµ‹è¯•&åˆ†æ
#### å®‰è£…
ROSä¸­çš„slam_gmappingåŒ…ä¹Ÿæ˜¯è°ƒç”¨äº†openslam_gmappingå¼€æºç®—æ³•, å› æ­¤éœ€è¦ä¸‹è½½ç¼–è¯‘ä¸¤ä¸ªä»£ç .

```bash
mkdir gmapping_ws
cd gmapping_ws
mkdir src
cd src
git clone https://github.com/ros-perception/slam_gmapping
git clone https://github.com/ros-perception/openslam_gmapping
cd ..
catkin_make
```

è®¢é˜…æ¶ˆæ¯:
```
scan : 2dæ¿€å…‰æ•°æ®, æ³¨æ„æ­£åè§’åº¦é¡ºåº
tf : é‡Œç¨‹æ•°æ®
```

### Reference
[æ•°æ®é›†è¿è¡ŒGmapping](https://www.jianshu.com/p/74fea75554ba)
[SLAMæ„å»ºåœ°å›¾â€”â€”gmappingåŠŸèƒ½åŒ…](http://xxty.fun/2019/08/19/ROS%E5%B0%8F%E8%BD%A6%EF%BC%9ASLAM%20%E6%9E%84%E5%BB%BA%E5%9C%B0%E5%9B%BE%20--%20gmapping%E5%8A%9F%E8%83%BD%E5%8C%85/)
[GMappingåŸç†åˆ†æ](https://blog.csdn.net/liuyanpeng12333/article/details/81946841)
[ç²’å­æ»¤æ³¢åŸç†åˆ†æ](https://gaoyichao.com/Xiaotu/?book=probabilistic_robotics&title=pr_chapter4)
[gmappingæºç é˜…è¯»](https://www.cnblogs.com/yhlx125/p/5634128.html)